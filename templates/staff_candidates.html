<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="/static/css/bulma_min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/tables.css">
  <title>BRAND Candidates</title>
</head>
<style>
</style>
<body class="has-navbar-fixed-top">
  {% include 'header.html' %}

  <div class="modal" id="cv_modal">
    <div class="modal-background" onclick="closeCVModal();"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">NAMETY NAME</p>
      </header>
      <section class="modal-card-body">
        {% include 'readable_cv.html' %}
      </section>
      <footer class="modal-card-foot">
        <button class="button" onclick="closeCVModal();">Cancel</button>
        <button class="button like_button">Like</button>
        <button class="button dislike_button">Dislike</button>
      </footer>
      </div>
    </div>

    <div class="modal" id="error_modal">
      <div class="modal-background" onclick="$(this).parent().removeClass('is-active');"></div>
      <div class="modal-content">
        <div class="box has-text-centered">
          <div class="modal-message">ERROR MESSAGE</div>
          <button class="modal-close is-large" aria-label="close" onclick="$(this).parent().parent().parent().removeClass('is-active');"></button>
        </div>
      </div>
    </div>

    <div id="job_id" class="is-hidden">{{ session['job_id'] }}</div>

  <table class="table is-hoverable is-fullwidth is-bordered is-striped" id="candidates_table">
  <thead>
    <tr>
      <th>Candidate</th>
      <th>Email</th>
      <th>Score</th>
      <th>CVs</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <tr class="candidate template">
      <td class="candidate_name"></td>
      <td class="candidate_email"></td>
      <td class="candidate_score"></td>
      <td>
        <a class="button is-rounded is-small cv_button" style="margin:2px">Show CV</a>
      </td>
      <td class="candidate_status"></td>
    </tr>
  </tbody>
</table>
</body>
<script src="/static/js/jquery-3.3.1.min.js"></script>
<script src="/static/js/staff_candidates.js"></script>
<script>
function refreshCandidates() {
  $.get("/staff/get_candidates", function(data) {

    if (data == "You are not logged in") {
      window.location.href="/";
    } else if (data == "Could not find candidates for this job, please reload the page") {
      alert(data);
      return;
    } else if (data == "Could not retrieve data from the database") {
      alert("Could not retrieve data at this time, please try again");
      return;
    }

    $('#candidates_table tbody .candidate:not(.template)').remove();

    // candidates = JSON.parse(data);

    candidates = [
      {
  			"ID":"999232",
  			"First Name":"John",
  			"Last Name":"Smith",
  			"Email":"John.Smith@gmail.com",
  		 	"Score":1032,
  		 	"CVID":7824,
  		 	"Status":"Unknown"
      },
      {
  			"ID":"999233",
  			"First Name":"Fred",
  			"Last Name":"Estair",
  			"Email":"Fred@gmail.com",
  		 	"Score":542,
  		 	"CVID":60,
  		 	"Status":"Like"
      },
      {
  			"ID":"999234",
  			"First Name":"Jane",
  			"Last Name":"Doe",
  			"Email":"J.Doe@gmail.com",
  		 	"Score":750,
  		 	"CVID":12,
  		 	"Status":"Dislike"
      },
    ];
    candidate_template = $('.candidate.template');
    for (i in candidates) {

      candidate = candidates[i];
      candidate_id = candidate["ID"];
      candidate_name = candidate["First Name"]+" "+candidate["Last Name"];
      candidate_email = candidate["Email"];
      candidate_score = candidate["Score"];
      candidate_cv = candidate["CVID"];
      candidate_status = candidate["Status"];

      // Insert all data into new row in table
      candidate_element = $(candidate_template).clone().removeClass('template').attr('id',candidate_id);
      $(candidate_element).find('.candidate_name').html(candidate_name);
      $(candidate_element).find('.candidate_email').html(candidate_email);
      $(candidate_element).find('.candidate_score').html(candidate_score);
      $(candidate_element).find('.candidate_status').html(candidate_status);
      $(candidate_element).find('.cv_button').attr('onclick','showCVModal(this,'+candidate_cv+');');

      // Insert job at top of table
      $(candidate_element).insertAfter($(candidate_template));
    }
  });
}

$(document).ready(function() {
  refreshCandidates();
});

function showCVModal(element,cv_id) {

  $.post("/staff/get_cv", {cv_id:cv_id}, function(data) {
    alert(data);
    // if (data == "Failure") {
    //   showErrorModal("There was an error retrieving this user's CV.<br>Please try again.");
    // } else {
    //   $('#cv_modal .like_button').attr('onclick','likeCandidate('+candidate_id+','+job_id+',this);').removeClass('is-hidden is-success').html('Like');
    //   $('#cv_modal .dislike_button').attr('onclick','dislikeCandidate('+candidate_id+','+job_id+',this);').removeClass('is-hidden is-danger').html('Dislike');
    //   $('#cv_modal').addClass('is-active');
    // }

  });
}

function showErrorModal(message) {
  $('#error_modal').addClass('is-active').find('.modal-message').html(message);
}

function closeCVModal() {
  $('#cv_modal').removeClass('is-active');
}

function likeCandidate(candidate_id,job_id,button) {
  $.post("/staff/like_candidate", {candidate_id:candidate_id, job_id:job_id}, function(data) {
    if (data == "Success") {
      $(button).attr('onclick','').html("Liked").addClass('is-success');
      $(button).parent().find('.dislike_button').addClass('is-hidden');
    } else {
      alert(data);
    }
  });
}

function dislikeCandidate(candidate_id,job_id,button) {
  $.post("/staff/dislike_candidate", {candidate_id:candidate_id, job_id:job_id}, function(data) {
    if (data == "Success") {
      $(button).attr('onclick','').html("Disliked").addClass('is-danger');
      $(button).parent().find('.like_button').addClass('is-hidden');
    } else {
      alert(data);
    }
  });
}

</script>
</html>
